
1. API 서버

   API 서버 는 다양한 외부 서비스나 프로그램에서 호출되기 때문에 동일한 사이트에서 동작하는 세션 기반의 로그인 처리 방식을 사용하는 대신
   특정한 식별 문자열(token토큰)을 이용하여 사용자를 식별한다. 최근 식별을 위한 토큰의 포맷은 JWT(JSON-Web Token) 형식으로 만료시간과 서명을 추가하여 좀 더 안전한 문자열을 만들어 적용한다. 

   API 서버의 인증에 관하여 알아두어야 할 중요한 사항은 API 서버를 이용하는 기업 간(B2B)의 경우 웹 서비스에서 자체적으로 회원데이터를 가지고 있으며,
   사용자의 정보를 유지할 수 있다. 이런 경우 API 서버는 A서비스가 가지고 있는 회원이 아니라 A서비스 자체가 한 명의 사용자가 되는 구성 방식 때문에
   API 서버는 대부분의 REST 경로에 대해서 인증 처리하는 방식으로 구성된다. 

   웹이 아닌 모바일 앱이나 SPA(Single Page Application)로 구성시 하나의 애플리케이션에서 모든 화면이 구성되고 필요한 데이터를
   API 서버를 호출해서 가져오게 되므로, API 서버는 브라우저에서 동작하는 애플리케이션의 구동에 필요한 사용자 정보도 같이 제공해야 해서
   로그인 역시 API 서버를통해서 구동된다. 모바일 앱은 사용자의 IP가  유동적으로 계속 변하기 때문에 이를 기반으로 하는 인증을 사용할 수 없다. 
   경우에 따라서 인증이 되지 않아도 호출할 수 있는 경로가 제공될 필요가 있지만 대신 그만큼 외부에서 호출할 수 있는 노출의 위험도 커지게 된다. 
   모바일앱 서비스 경우 자신을 증명할수 있는 정보를 API 서버로 보내주고 API 서버에서는 사용할 수 있는 인증 토큰을 전송해 준다.
   이후 모든 호출은 인증 토큰을 같이 전송한다. 
   이를 토큰기반의 인증(Token-based authentication)이라고 하며, API 서버 호출에 사용하는 토큰을 액세스토큰(Access Token)이라고 한다. 

2. Ajax와 스프링 시큐리티

   API 서버는 화면이 없기 때문에 대부분의 호출은 Ajax를 이용하거나 HTTP 통신 프로그램/라이브러리를 통해서 이루어진다.
   Ajax를 이용하는 경우 외부에서 API 서버를 마음대로 호출할 수 없도록 제한할 수 있는 방법이 필요하다.
   외부에서 API 서버의 접근에 대한 처리를 직접 구현하는 것도 가능하겠지만, 스프링 시큐리티를 이용하면 기본적으로 제공하는 필터와 설정을 이용하여 개발의 생산성을 높일 수 있다.

     2.1 프로젝트 생성과 시큐리티 라이브러리
  
      - 스프링 부트를 이용하면 시큐리티 관련 라이브러리는 프로젝트 생성 시에 설정이 가능하다. 프로젝트 생성 시 'implementation 'org.springframework.boot:spring-boot-starter-security' 추가 (build.gradle) 업데이트 

      - 시큐리티와 관련된 코드들의 동작을 자세히 확인하기 위해서 로그관련 설정을 추가한다. application.properties 
       시큐리티가 포함되는 경우 프로젝트의 실행 시에는 임시로 사용할 수 있는 패스워드가 생성되는 것을 확인한다.
       /login 경로를 호출하면 스프링에서 제공하는 화면 제공 이화면은 별도의 파일로 생성되지 않고 스프링 시큐리티가 실행되면서 만들어지는 화면이다. 

      - 설정 파일과 passwordEncoder
       스프링 부트의 경우 application.properties를 이용하여 기본적인 환경 셋팅을 지정하고, 별도의 설정 클래스를 이용하여 빈(Bean)들에 대한 설정을 처리한다.
       이때 해당 클래스는 @Configuration 을 붙여서 표시한다.

     - config>CustomSecurityConfig 클래스 추가 
       스프링 시큐리티는 기본적으로 사용자의 인증 정보를 확인 할때 패스워드는 반드시 PasswordEncoder 라는 것을 이용하게 되어 있다. 
       PasswordEncoder 는 기본적으로 인터페이스이기 때문에 개발자가 직접 구현할 수도 있지만  구현 클래스를 선택하여 사용하여 쓰는 것이 일반적이다.
       PasswordEncoder 는 BCryptPasswordEncoder 이다.  BCryptPasswordEncoder는 일반적인 웹 환경에서 많이 사용되는데 동일한 패스워드라고 해도 매번 다른 결과로 만들어지기 때문에 사용자의 정보를 안전하게 보관할 수 있다. 
       BCrypt해싱 알고리즘을 사용하여 비밀번호를 안전하게 저장하는 것을 의미.  BCrypt는 계산적으로나, 집약적으로 설계되어 있어 무차별 대입 공격을 방지하는데 효과적이어서 많은 응용프로그램에서 비번 해싱을 위해 널리 사용되다.


3. API 서버의 시큐리티
  시큐리티를 이용한다고 하면 사용자의 인증(authentication)이나 인가(authorization)작업 처리를 다루게 된다. 

   - 인증(authentication) : 사용자가 스스로 자신을 증명하는 것(인증 정보는 사용자가 직접 제공)
   - 인가(authorization) : 인증된 사용자에 대한 '허가', 특정한 건물이나 사무실에 들어가기 위한 출입증을 받는 것과 동일한 개념


   - JWT 기반의 인증은 일반적인 로그인과 약간 다른 부분들이 있다. 
     일반적인 로그인의 경우 로그인 후에는 사용자는 즉각적인 표력을 발휘하게 된다. 로그인을 한 후에는 바로 원하는 작업을 수행할 수 있다는 의미이다. 
     반면에 API서버는 로그인이라는 개념이 없다. API 서버는 데이터를 제공하기 위해서만 존재하고 어떠한 상태도 유지하지 않는 순수한 함수 같은 존재이다. API 서버는 기본적으로 무상태(statelsee)로 서비스가 된다. 

     API 서버에서는 사용자의 상태를 유지하지 않기 때문에 API서버는 사용자의 정보를 세션등으로 유지하는 방식 대신 매번 사용자가 자신을 증멸할 수 있는 정보(token)을 가지고 요청하는 방식으로 처리된다.
     API 서버는 로그인 이라는 개념 대신에 식별을 위한 토큰(token)을 얻는과정과 발행된 토큰을 이용해서 원하는 데이터에 접근하는 과정만 있다.
     API 서버는 무상태(stateless) - API 서버는 사용자의 어떠한 상태도 보관하지 않는다. 토큰 기반 인증을 이용하는 API 서버의 입장에서는 전달된 'token'의 유효성이 중요하다.
     API 서버는 문제가 발생하는 경우 화면이 없기 때문에 이에 해당하는 HTTP 상태코드와 예외 메시지를 전송해 주는 방식으로 구현된다. 이를 위해 다양한 상황에 맞게 예외를 준비하고 처리해 주어야 한다. 

   
5. JWT
   
      별도의 형식으로 만들어진 독특한 문자열이다. JWT 문자열은 JSON객체를 인코딩해서 구성되는데 완성된 문자열은 헤더(header)-내용(payload)-서명(signature) 으로 구성된다. 각 부분은 '.'을 통해 구분된다.
      - 헤더(header): JWT의 유형 및 사용된 해싱 알고리즘을 지정한다. Base64로 인코딩되어 있다.
      - 내용(payload): 토큰에 포함되는 클레임(claim)정보가 담겨 있다. 클레임은 사용자에 대한 정보 또는 기타 데이터를 의미하여, 세가지 유형으로 나뉜다. registered, private, pubic Base64로 인코딩 된다.
      - 서명(signature): Header와 Payload를 함께 사용해 생성된 서명이다. 이 서명은 토큰이 변조되지 않았음을 보장한다.
        
        토큰 기반 인증 방식의 가장 문제는 토큰이 탈취되는 상황인데 JWT는 내용에 만료시간을 지정할 수 있어서 탈취된 토큰의 피해를 줄 일 수 있다. 
